<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neumorphic Puzzle Alarm Clock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Define CSS variables for consistent theming */
        :root {
            --bg-color: #e0f2fe; /* Ice Blue */
            --primary-color: #ef4444; /* Red */
            --text-color: #1f2937; /* Dark Gray/Black */
            --white-color: #ffffff;
        }

        /* Base body styles, applying Inter font and background color */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            touch-action: none; /* Prevents scrolling on touch devices during drag operations */
        }

        /* Neumorphic style for main containers */
        .neumorphic {
            border-radius: 2rem;
            background: var(--bg-color);
            box-shadow: 12px 12px 24px #b3c1c9, -12px -12px 24px var(--white-color);
        }

        /* Neumorphic inset style for input fields or embedded sections */
        .neumorphic-inset {
            border-radius: 1.5rem;
            background: var(--bg-color);
            box-shadow: inset 8px 8px 16px #b3c1c9, inset -8px -8px 16px var(--white-color);
        }
        
        /* Neumorphic button style with hover and active states */
        .neumorphic-button {
            border-radius: 1rem;
            background: var(--bg-color);
            box-shadow: 6px 6px 12px #b3c1c9, -6px -6px 12px var(--white-color);
            transition: all 0.2s ease-in-out;
        }

        /* Inset shadow on button press or active state */
        .neumorphic-button:active, .neumorphic-button.active {
            box-shadow: inset 6px 6px 12px #b3c1c9, inset -6px -6px 12px var(--white-color);
        }

        /* Styles for the modal backdrop when alarm triggers */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        
        /* Styles for the Order Puzzle drop targets */
        .drop-target {
            width: 50px;
            height: 50px;
            background-color: var(--bg-color);
            box-shadow: inset 4px 4px 8px #b3c1c9, inset -4px -4px 8px var(--white-color);
        }
        /* Style for a filled drop target */
        .drop-target.filled {
             box-shadow: none; /* Remove inset shadow once filled */
        }
        /* Styles for draggable puzzle pieces */
        .draggable-piece {
            width: 50px;
            height: 50px;
            cursor: grab; /* Indicates draggable */
            user-select: none; /* Prevents text selection during drag */
            box-shadow: 4px 4px 8px #b3c1c9, -4px -4px 8px var(--white-color);
        }
        /* Cursor change when dragging a piece */
        .draggable-piece:active {
            cursor: grabbing;
        }
        /* Opacity change for the piece being dragged */
        .dragging {
            opacity: 0.5;
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md p-8 neumorphic">
        
        <div class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-bold tracking-wider" id="currentTime">00:00:00</h1>
            <p class="text-lg text-gray-500" id="currentDate">Monday, January 1, 2024</p>
        </div>

        <div class="neumorphic-inset p-6 mb-6">
            <div class="flex justify-center items-center space-x-4">
                <select id="alarmHour" class="bg-transparent text-4xl appearance-none focus:outline-none cursor-pointer"></select>
                <span class="text-4xl">:</span>
                <select id="alarmMinute" class="bg-transparent text-4xl appearance-none focus:outline-none cursor-pointer"></select>
            </div>
        </div>
        
        <div class="mb-8">
            <p class="text-center text-gray-600 mb-3 font-medium">Alarm Sound</p>
            <div class="flex flex-col gap-3">
                <select id="alarmSoundSelect" class="w-full neumorphic-inset p-3 text-lg focus:outline-none cursor-pointer">
                    <option value="default_chime.mp3">Chime (Default)</option>
                    <option value="default_bell.mp3">Bell</option>
                    <option value="default_horn.mp3">Horn</option>
                </select>
                <div class="neumorphic-button py-3 px-4 flex items-center justify-between cursor-pointer" id="customSoundUploadBtn">
                    <span id="customSoundFileName" class="text-gray-600 text-lg">Upload Custom Sound...</span>
                    <input type="file" id="customSoundInput" accept="audio/*" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <p class="text-center text-gray-600 mb-3 font-medium">Puzzle Type</p>
            <div class="flex justify-center gap-4">
                <button id="selectMathPuzzle" class="neumorphic-button puzzle-btn active flex-1 py-3">Math</button>
                <button id="selectOrderPuzzle" class="neumorphic-button puzzle-btn flex-1 py-3">Order</button>
            </div>
        </div>

        <div class="flex justify-center">
            <button id="setAlarmBtn" class="neumorphic-button text-xl font-bold py-4 px-10 text-gray-700 hover:text-red-500">
                Set Alarm
            </button>
        </div>
        
        <div id="statusMessage" class="text-center mt-6 h-6 text-lg font-medium text-gray-600"></div>

        <footer class="text-center text-red-500 text-sm mt-8">
            @MadlerProductions
        </footer>
    </div>

    <div id="puzzleModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="neumorphic w-full max-w-sm p-6 text-center">
            <h2 class="text-2xl font-bold mb-2">ALARM!</h2>
            <p class="mb-4 text-lg">Solve the puzzle to stop the alarm.</p>
            
            <div id="mathPuzzleContainer" class="hidden">
                <div class="neumorphic-inset p-6 mb-6">
                    <p id="puzzleQuestion" class="text-4xl font-bold"></p>
                </div>
                <input type="number" id="puzzleAnswer" class="w-full neumorphic-inset p-4 text-2xl text-center focus:outline-none mb-4" placeholder="Your Answer">
                <button id="submitPuzzleBtn" class="w-full neumorphic-button bg-red-500 text-white text-xl font-bold py-4">Submit</button>
                <p id="puzzleError" class="text-red-500 h-5 mt-2"></p>
            </div>
            
            <div id="orderPuzzleContainer" class="hidden">
                    <p id="orderMessage" class="h-5 mb-4 text-gray-600">Drag numbers to the correct slots.</p>
                    <div id="drop-targets" class="neumorphic-inset p-3 mb-4 flex flex-wrap justify-center gap-2">
                        </div>
                    <div id="piece-container" class="p-3 flex flex-wrap justify-center gap-3">
                        </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const currentTimeEl = document.getElementById('currentTime');
            const currentDateEl = document.getElementById('currentDate');
            const alarmHourEl = document.getElementById('alarmHour');
            const alarmMinuteEl = document.getElementById('alarmMinute');
            const setAlarmBtn = document.getElementById('setAlarmBtn');
            const statusMessage = document.getElementById('statusMessage');
            
            const puzzleBtns = document.querySelectorAll('.puzzle-btn');
            const puzzleModal = document.getElementById('puzzleModal');

            // Alarm Sound Elements (NEW)
            const alarmSoundSelect = document.getElementById('alarmSoundSelect');
            const customSoundUploadBtn = document.getElementById('customSoundUploadBtn');
            const customSoundInput = document.getElementById('customSoundInput');
            const customSoundFileName = document.getElementById('customSoundFileName');

            // Puzzle Containers and Elements
            const mathPuzzleContainer = document.getElementById('mathPuzzleContainer');
            const orderPuzzleContainer = document.getElementById('orderPuzzleContainer');
            const puzzleQuestionEl = document.getElementById('puzzleQuestion');
            const puzzleAnswerEl = document.getElementById('puzzleAnswer');
            const submitPuzzleBtn = document.getElementById('submitPuzzleBtn');
            const puzzleErrorEl = document.getElementById('puzzleError');
            const dropTargetsContainer = document.getElementById('drop-targets');
            const pieceContainer = document.getElementById('piece-container');
            const orderMessage = document.getElementById('orderMessage');

            // --- State Variables ---
            let alarmTime = null; // Stores the set alarm time (e.g., "08:30")
            let alarmActive = false; // True when alarm is ringing
            let puzzleType = 'math'; // Currently selected puzzle type: 'math' or 'order'
            let mathPuzzleSolution = 0; // Solution for the current math puzzle
            let currentAlarmSound = 'default_chime.mp3'; // Path/URL of the selected alarm sound
            let customSoundObjectURL = null; // Temporary URL for user-uploaded sound file

            // --- Sound Synthesis ---
            let alarmPlayer; // Tone.Player instance for playing alarm sounds
            let alarmLoop; // Tone.Loop instance for repeating the alarm sound

            // Set Tone.js lookAhead for lower latency
            Tone.context.lookAhead = 0.05; 

            // --- Clock & Date Logic ---
            /**
             * Updates the current time and date displayed on the clock.
             * Also checks if the alarm should be triggered.
             */
            function updateTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                
                currentTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
                currentDateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                // Check if alarm should trigger
                if (alarmTime && !alarmActive) {
                    const [alarmH, alarmM] = alarmTime.split(':');
                    // Trigger alarm if current hour and minute match, and seconds are near 0
                    if (parseInt(alarmH) === now.getHours() && parseInt(alarmM) === now.getMinutes() && now.getSeconds() < 2) {
                        triggerAlarm();
                    }
                }
            }

            // --- Setup ---
            /**
             * Populates the hour and minute dropdown selectors.
             */
            function populateSelectors() {
                for (let i = 0; i < 24; i++) alarmHourEl.add(new Option(String(i).padStart(2, '0'), i));
                for (let i = 0; i < 60; i++) alarmMinuteEl.add(new Option(String(i).padStart(2, '0'), i));
            }

            // --- Alarm Controls ---
            /**
             * Sets or clears the alarm based on current state.
             * Also loads the selected alarm sound.
             */
            async function setAlarm() { // Made async
                // Start Tone.js audio context on user interaction (browser requirement)
                if (Tone.context.state !== 'running') {
                    await Tone.start(); // Await Tone.start() to ensure context is running
                }

                // If alarm is already set, clear it
                if (setAlarmBtn.classList.contains('active')) {
                    clearAlarm();
                    return;
                }
                
                // Get selected hour and minute
                const hour = alarmHourEl.value;
                const minute = alarmMinuteEl.value;
                alarmTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                // Update UI for set alarm state
                setAlarmBtn.textContent = 'Clear Alarm';
                setAlarmBtn.classList.add('active');
                statusMessage.textContent = `Alarm set for ${alarmTime}`;

                // Load the selected alarm sound and WAIT for it to load
                await loadAlarmSound(currentAlarmSound); // Await loading to ensure player is ready
            }

            /**
             * Clears the active alarm and resets UI.
             */
            function clearAlarm() {
                alarmTime = null;
                alarmActive = false;
                
                // Reset UI for clear alarm state
                setAlarmBtn.textContent = 'Set Alarm';
                setAlarmBtn.classList.remove('active');
                statusMessage.textContent = 'Alarm cleared.';
                setTimeout(() => statusMessage.textContent = '', 2000); // Clear message after 2 seconds

                // Stop and dispose of the alarm player if it's not currently playing
                if (alarmPlayer && alarmPlayer.state !== 'stopped') { // Check state before disposing
                    alarmPlayer.stop(); // Attempt to stop if playing
                    alarmPlayer.dispose(); 
                    alarmPlayer = null;
                }
            }

            /**
             * Triggers the alarm: shows puzzle modal and starts playing sound.
             */
            function triggerAlarm() {
                if(alarmActive) return; // Prevent multiple triggers if already active
                alarmActive = true;
                puzzleModal.classList.remove('hidden'); // Show the puzzle modal
                
                // Show the correct puzzle container based on selection
                if (puzzleType === 'math') {
                    mathPuzzleContainer.classList.remove('hidden');
                    orderPuzzleContainer.classList.add('hidden');
                    generateMathPuzzle();
                } else { // puzzleType === 'order'
                    orderPuzzleContainer.classList.remove('hidden');
                    mathPuzzleContainer.classList.add('hidden');
                    initOrderPuzzle();
                }

                // Ensure Tone.js context is running (should be handled by setAlarm, but good to double check)
                if (Tone.context.state !== 'running') {
                    Tone.start(); 
                }

                // Set master volume to 0dB (full volume)
                Tone.Destination.volume.value = 0; 

                // Stop any existing loop and transport if they are active before starting a new one
                if (alarmLoop) {
                    alarmLoop.stop();
                    alarmLoop.dispose();
                    alarmLoop = null;
                }
                if (Tone.Transport.state === 'started') {
                    Tone.Transport.stop(); 
                }
                // Dispose of previous player if it somehow wasn't disposed (should be by stopAlarm)
                if (alarmPlayer && alarmPlayer.state !== 'stopped') { 
                    alarmPlayer.stop(); // Attempt to stop if it's playing
                    alarmPlayer.dispose();
                    alarmPlayer = null;
                }

                // Now, alarmPlayer should be loaded because setAlarm awaited loadAlarmSound
                if (alarmPlayer && alarmPlayer.loaded) { // Crucial check: only proceed if player is loaded
                    alarmPlayer.loop = true; 
                    alarmLoop = new Tone.Loop(time => {
                        // Double check inside the loop callback as well
                        if (alarmPlayer && alarmPlayer.loaded) { 
                            alarmPlayer.start(time);
                        }
                    }, '1s').start(0); // Play every second (adjust interval as needed)

                    Tone.Transport.start(); 
                } else {
                    // Fallback to a simple synth if no sound is loaded or player not ready
                    console.warn("Alarm player not available or not loaded. Using fallback synth.");
                    const fallbackSynth = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();
                    alarmLoop = new Tone.Loop(time => fallbackSynth.triggerAttackRelease('C5', '8n', time), '4n').start(0);
                    Tone.Transport.start();
                }
            }
            
            /**
             * Stops the alarm: hides puzzle modal, stops sound, and resets alarm state.
             * @param {string} message - Optional message to display after stopping.
             */
            function stopAlarm(message = 'Alarm stopped!') {
                // Stop and dispose of Tone.js elements
                if (alarmLoop) {
                    alarmLoop.stop();
                    alarmLoop.dispose();
                    alarmLoop = null;
                }
                // Only stop alarmPlayer if it's currently playing
                if (alarmPlayer && alarmPlayer.state === 'started') { 
                    alarmPlayer.stop(); 
                }
                // Always dispose if it exists to free resources
                if (alarmPlayer) { 
                    alarmPlayer.dispose(); 
                    alarmPlayer = null;
                }
                
                // Only stop transport if it's running
                if (Tone.Transport.state === 'started') { 
                    Tone.Transport.stop(); 
                }

                alarmActive = false;
                alarmTime = null;
                puzzleModal.classList.add('hidden');
                setAlarmBtn.textContent = 'Set Alarm';
                setAlarmBtn.classList.remove('active');
                statusMessage.textContent = message;
                setTimeout(() => statusMessage.textContent = '', 3000);

                customSoundFileName.textContent = 'Upload Custom Sound...';
                if (customSoundObjectURL) {
                    URL.revokeObjectURL(customSoundObjectURL);
                    customSoundObjectURL = null;
                }
                alarmSoundSelect.value = 'default_chime.mp3';
            }

            // --- Alarm Sound Logic (NEW) ---
            /**
             * Loads the specified alarm sound into a Tone.Player.
             * Disposes of any previous player to manage memory.
             * Returns a Promise that resolves when the sound is loaded or a fallback is set.
             * @param {string} soundSrc - The source identifier for the sound (filename or 'custom_sound').
             */
            function loadAlarmSound(soundSrc) {
                return new Promise((resolve) => { // Return a Promise to indicate loading completion
                    // Dispose of any existing player to prevent memory leaks
                    if (alarmPlayer) {
                        alarmPlayer.dispose(); 
                    }

                    let playerUrl = '';
                    if (soundSrc === 'custom_sound' && customSoundObjectURL) {
                        playerUrl = customSoundObjectURL;
                    } else if (soundSrc.startsWith('default_')) {
                        playerUrl = `sounds/${soundSrc}`;
                    } else {
                        // Fallback to synth if source is invalid, and resolve immediately
                        console.error("Invalid sound source provided or custom sound not loaded:", soundSrc);
                        alarmPlayer = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();
                        alarmPlayer.autostart = false;
                        resolve();
                        return;
                    }
                    
                    // Create new Tone.Player with an onload callback
                    alarmPlayer = new Tone.Player(playerUrl, () => { 
                        console.log(`Alarm sound "${soundSrc}" loaded.`);
                        resolve(); // Resolve the promise when the buffer is loaded
                    }).toDestination();
                    alarmPlayer.autostart = false; 
                    
                    // Handle potential error during loading
                    alarmPlayer.onerror = (e) => {
                        console.error(`Error loading sound "${soundSrc}":`, e);
                        // Fallback to synth on error and resolve
                        if (alarmPlayer) alarmPlayer.dispose();
                        alarmPlayer = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();
                        alarmPlayer.autostart = false;
                        resolve(); // Still resolve so setAlarm can continue
                    };
                });
            }

            /**
             * Event listener for when a pre-defined alarm sound is selected from the dropdown.
             */
            alarmSoundSelect.addEventListener('change', async (e) => { // Made async
                currentAlarmSound = e.target.value;
                // If a default sound is selected, clear any custom sound information
                if (currentAlarmSound !== 'custom_sound') {
                    if (customSoundObjectURL) {
                        URL.revokeObjectURL(customSoundObjectURL);
                        customSoundObjectURL = null;
                    }
                    customSoundInput.value = ''; // Clear the file input element
                    customSoundFileName.textContent = 'Upload Custom Sound...'; // Reset display text
                }
                console.log("Selected alarm sound:", currentAlarmSound);
                // Load the newly selected sound and wait for it
                await loadAlarmSound(currentAlarmSound); 
            });

            /**
             * Event listener to trigger the hidden file input when the custom upload button is clicked.
             */
            customSoundUploadBtn.addEventListener('click', () => {
                customSoundInput.click(); // Programmatically click the hidden file input
            });

            /**
             * Event listener for when a custom sound file is selected by the user.
             */
            customSoundInput.addEventListener('change', async (e) => { // Made async
                const file = e.target.files[0]; // Get the selected file
                if (file) {
                    // Revoke previous object URL if it exists to prevent memory leaks
                    if (customSoundObjectURL) {
                        URL.revokeObjectURL(customSoundObjectURL);
                    }
                    customSoundObjectURL = URL.createObjectURL(file); // Create a temporary URL for the file
                    currentAlarmSound = 'custom_sound'; // Update the current alarm sound state
                    customSoundFileName.textContent = file.name; // Display the name of the uploaded file
                    alarmSoundSelect.value = ''; // Deselect any pre-defined option in the dropdown

                    console.log("Custom sound selected:", currentAlarmSound);
                    await loadAlarmSound(currentAlarmSound); // Load the newly selected custom sound and wait
                } else {
                    // If no file was selected (e.g., user cancelled the dialog)
                    if (!alarmSoundSelect.value) { // If custom was previously selected and now cleared
                        alarmSoundSelect.value = 'default_chime.mp3'; // Revert to default chime
                        currentAlarmSound = 'default_chime.mp3';
                    }
                    customSoundFileName.textContent = 'Upload Custom Sound...'; // Reset display text
                    if (customSoundObjectURL) {
                        URL.revokeObjectURL(customSoundObjectURL); // Revoke the old URL
                        customSoundObjectURL = null;
                    }
                    await loadAlarmSound(currentAlarmSound); // Load the (now default) sound and wait
                }
            });


            // --- Puzzle Selection ---
            /**
             * Handles the selection of the puzzle type (Math or Order).
             * @param {Event} e - The click event object.
             */
            function selectPuzzle(e) {
                puzzleType = e.target.id === 'selectMathPuzzle' ? 'math' : 'order';
                // Remove 'active' class from all puzzle buttons and add to the clicked one
                puzzleBtns.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }

            // --- Math Puzzle Logic ---
            /**
             * Generates a new math addition puzzle.
             */
            function generateMathPuzzle() {
                const num1 = Math.floor(Math.random() * 20) + 1;
                const num2 = Math.floor(Math.random() * 20) + 1;
                mathPuzzleSolution = num1 + num2;
                puzzleQuestionEl.textContent = `${num1} + ${num2} = ?`;
                puzzleAnswerEl.value = ''; // Clear previous answer
                puzzleErrorEl.textContent = ''; // Clear previous error message
            }

            /**
             * Checks if the user's answer to the math puzzle is correct.
             */
            function checkMathPuzzle() {
                if (parseInt(puzzleAnswerEl.value) === mathPuzzleSolution) {
                    stopAlarm(); // Stop alarm if correct
                } else {
                    puzzleErrorEl.textContent = 'Wrong answer. Try again!';
                    setTimeout(() => puzzleErrorEl.textContent = '', 2000); // Clear error after 2 seconds
                }
            }

            // --- Order Puzzle Logic ---
            /**
             * Initializes the order puzzle by creating drop targets and draggable pieces.
             */
            function initOrderPuzzle() {
                dropTargetsContainer.innerHTML = ''; // Clear previous targets
                pieceContainer.innerHTML = ''; // Clear previous pieces
                orderMessage.textContent = 'Drag numbers to the correct slots.';

                const numbers = Array.from({length: 10}, (_, i) => i + 1); // Numbers 1-10
                
                // Create 10 drop target divs
                for(let i = 1; i <= 10; i++) {
                    const target = document.createElement('div');
                    target.classList.add('drop-target', 'rounded-lg', 'flex', 'items-center', 'justify-center');
                    target.dataset.expectedValue = i; // Store the expected value for this target
                    dropTargetsContainer.appendChild(target);
                }

                // Create and shuffle draggable number pieces
                numbers.sort(() => Math.random() - 0.5); // Shuffle the array
                numbers.forEach(num => {
                    const piece = document.createElement('div');
                    piece.id = `piece-${num}`; // Unique ID for each piece
                    piece.textContent = num; // Display the number
                    piece.draggable = true; // Make it draggable
                    piece.classList.add('draggable-piece', 'rounded-lg', 'flex', 'items-center', 'justify-center', 'text-xl', 'font-bold');
                    pieceContainer.appendChild(piece);
                });
            }
            
            /**
             * Handles the start of a drag operation for puzzle pieces.
             * @param {Event} e - The dragstart event object.
             */
            function handleDragStart(e) {
                e.dataTransfer.setData('text/plain', e.target.id); // Store the ID of the dragged element
                e.target.classList.add('dragging'); // Add dragging class for visual feedback
            }

            /**
             * Prevents default behavior for dragover to allow dropping.
             * @param {Event} e - The dragover event object.
             */
            function handleDragOver(e) {
                e.preventDefault(); 
            }

            /**
             * Handles the drop operation for puzzle pieces.
             * @param {Event} e - The drop event object.
             */
            function handleDrop(e) {
                e.preventDefault();
                const pieceId = e.dataTransfer.getData('text/plain'); // Get the ID of the dragged piece
                const piece = document.getElementById(pieceId);
                const target = e.target.closest('.drop-target'); // Find the closest drop target

                // Check if a piece and a valid, empty target exist
                if (piece && target && !target.hasChildNodes()) {
                    const pieceValue = piece.textContent;
                    const expectedValue = target.dataset.expectedValue;

                    if (pieceValue === expectedValue) {
                        target.appendChild(piece); // Move the piece to the target
                        piece.classList.remove('dragging');
                        piece.draggable = false; // Make piece non-draggable once placed correctly
                        target.classList.add('filled'); // Mark target as filled
                        orderMessage.textContent = 'Correct!';
                        checkOrderPuzzleWin(); // Check for win condition
                    } else {
                        orderMessage.textContent = 'Wrong spot! Try again.';
                        piece.classList.remove('dragging'); // Remove dragging class immediately on wrong drop
                        setTimeout(() => orderMessage.textContent = 'Drag numbers to the correct slots.', 1500); // Clear message
                    }
                } else if (piece) { // If dropped outside a valid target or on a filled target
                    piece.classList.remove('dragging');
                    orderMessage.textContent = 'Invalid drop. Try again.';
                    setTimeout(() => orderMessage.textContent = 'Drag numbers to the correct slots.', 1500); // Clear message
                }
            }

            /**
             * Handles the end of a drag operation for puzzle pieces.
             * @param {Event} e - The dragend event object.
             */
            function handleDragEnd(e) {
                e.target.classList.remove('dragging'); // Ensure dragging class is removed
            }

            /**
             * Checks if all order puzzle pieces are in their correct places.
             */
            function checkOrderPuzzleWin() {
                const dropTargets = Array.from(dropTargetsContainer.children);
                const allCorrect = dropTargets.every(target => {
                    if (target.hasChildNodes()) {
                        const piece = target.firstElementChild;
                        return piece.textContent === target.dataset.expectedValue;
                    }
                    return false; // Target is empty
                });

                if (allCorrect) {
                    stopAlarm('Order Puzzle Solved! Alarm stopped!');
                }
            }


            // --- Event Listeners ---
            setAlarmBtn.addEventListener('click', setAlarm);
            submitPuzzleBtn.addEventListener('click', checkMathPuzzle);
            puzzleAnswerEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkMathPuzzle();
            });

            puzzleBtns.forEach(button => {
                button.addEventListener('click', selectPuzzle);
            });

            // Add event listeners for drag and drop to the puzzle modal
            puzzleModal.addEventListener('dragstart', handleDragStart);
            puzzleModal.addEventListener('dragover', handleDragOver);
            puzzleModal.addEventListener('drop', handleDrop);
            puzzleModal.addEventListener('dragend', handleDragEnd); // Handle drag end for all draggable pieces

            // Initial calls
            populateSelectors();
            setInterval(updateTime, 1000); // Update time every second
            updateTime(); // Initial call to display time immediately
        });
    </script>
</body>
</html>